rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ══════════════════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ══════════════════════════════════════════════════════════════════════════

    // Basic auth check
    function isAuthed() {
      return request.auth != null;
    }

    // Returns true if the caller belongs to the given agencyId (via Custom Claims).
    function inAgency(agencyId) {
      return isAuthed() && (
        request.auth.token.agencyId == agencyId
        || (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.agencyId == agencyId)
      );
    }

    // Returns true if the caller is an admin (via Custom Claims).
    function isAdmin() {
      return isAuthed() && (
        request.auth.token.role == 'admin'
        || (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // Returns true if the caller is an admin in the given agency.
    function isAgencyAdmin(agencyId) {
      return inAgency(agencyId) && isAdmin();
    }

    // Returns true if the caller is a system-wide super admin.
    function isSuperAdmin() {
      return isAuthed() && exists(/databases/$(database)/documents/superAdmins/$(request.auth.uid));
    }

    // Data validation helpers
    function isNonEmptyString(val) {
      return val is string && val.size() > 0;
    }

    function isPositiveNumber(val) {
      return val is number && val > 0;
    }

    // Prevents moving a document to a different agency on update.
    function agencyIdUnchanged() {
      return request.resource.data.agencyId == resource.data.agencyId;
    }


    // ══════════════════════════════════════════════════════════════════════════
    // DEFAULT DENY — all paths not explicitly matched below are denied.
    // ══════════════════════════════════════════════════════════════════════════
    match /{document=**} {
      allow read, write: if false;
    }


    // ══════════════════════════════════════════════════════════════════════════
    // AGENCIES
    // ══════════════════════════════════════════════════════════════════════════
    match /agencies/{agencyId} {
      allow read: if isAuthed() && (inAgency(agencyId) || isSuperAdmin());
      allow create: if false; // Agencies can only be created via Cloud Functions (Stripe Webhook or Onboarding)
      allow update: if isAuthed()
          && inAgency(agencyId)
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'monthlyGoals', 'yearlyGoals', 'settings',
            'agencyName', 'slogan', 'officePhone', 'licenseNumber', 'mainServiceArea', 'specialization',
            'whatsappIntegration'
          ]);
      allow delete: if false;
    }


    // ══════════════════════════════════════════════════════════════════════════
    // AGENCY AGENTS (Subcollection)
    // ══════════════════════════════════════════════════════════════════════════
    match /agencies/{agencyId}/agents/{agentId} {
      // Inherits the tenant isolation rules of the parent agency
      allow read: if isAuthed() && inAgency(agencyId);
      allow create, update, delete: if isAuthed() && isAgencyAdmin(agencyId);
    }


    // ══════════════════════════════════════════════════════════════════════════
    // USERS
    // ══════════════════════════════════════════════════════════════════════════
    match /users/{userId} {
      allow read: if isAuthed() && (
        request.auth.uid == userId // can read own profile
        || isSuperAdmin()          // system admins
        || (resource != null && inAgency(resource.data.agencyId)) // anyone in same agency
      );
      // Stub creation and UID linking must go through Cloud Functions. 
      allow create: if false;
      allow update: if isAuthed() && (request.auth.uid == userId || isAdmin());
      allow delete: if false;
    }


    // ══════════════════════════════════════════════════════════════════════════
    // PROPERTIES
    // ══════════════════════════════════════════════════════════════════════════
    match /properties/{propertyId} {
      allow read: if isAuthed() && (inAgency(resource.data.agencyId) || isSuperAdmin());
      allow create: if isAuthed()
          && inAgency(request.resource.data.agencyId)
          && isNonEmptyString(request.resource.data.city)
          && isNonEmptyString(request.resource.data.address)
          && isNonEmptyString(request.resource.data.type)
          && isPositiveNumber(request.resource.data.price);

      allow update: if isAuthed()
          && inAgency(resource.data.agencyId)
          && agencyIdUnchanged();

      allow delete: if isAuthed() && (
        isAgencyAdmin(resource.data.agencyId) ||
        resource.data.createdBy == request.auth.uid
      );
    }


    // ══════════════════════════════════════════════════════════════════════════
    // LEADS
    // ══════════════════════════════════════════════════════════════════════════
    match /leads/{leadId} {
      allow read: if isAuthed() && (inAgency(resource.data.agencyId) || isSuperAdmin());
      allow create: if isAuthed()
          && inAgency(request.resource.data.agencyId)
          && isNonEmptyString(request.resource.data.name)
          && isNonEmptyString(request.resource.data.phone);

      allow update: if isAuthed()
          && inAgency(resource.data.agencyId)
          && agencyIdUnchanged();

      allow delete: if isAuthed() && isAgencyAdmin(resource.data.agencyId);
    }


    // ══════════════════════════════════════════════════════════════════════════
    // LEAD MESSAGES (Subcollection)
    // ══════════════════════════════════════════════════════════════════════════
    match /leads/{leadId}/messages/{messageId} {
      allow read: if isAuthed() && inAgency(get(/databases/$(database)/documents/leads/$(leadId)).data.agencyId);
      allow create: if isAuthed() && inAgency(get(/databases/$(database)/documents/leads/$(leadId)).data.agencyId);
      allow update: if isAuthed()
          && inAgency(get(/databases/$(database)/documents/leads/$(leadId)).data.agencyId)
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);

      allow delete: if isAuthed() && isAgencyAdmin(get(/databases/$(database)/documents/leads/$(leadId)).data.agencyId);
    }


    // ══════════════════════════════════════════════════════════════════════════
    // DEALS
    // ══════════════════════════════════════════════════════════════════════════
    match /deals/{dealId} {
      allow read: if isAuthed() && inAgency(resource.data.agencyId);
      allow create: if isAuthed()
          && inAgency(request.resource.data.agencyId)
          && isNonEmptyString(request.resource.data.stage)
          && request.resource.data.projectedCommission is number
          && request.resource.data.projectedCommission >= 0;
      allow update: if isAuthed()
          && inAgency(resource.data.agencyId)
          && agencyIdUnchanged();

      allow delete: if isAuthed() && isAgencyAdmin(resource.data.agencyId);
    }


    // ══════════════════════════════════════════════════════════════════════════
    // TASKS
    // ══════════════════════════════════════════════════════════════════════════
    match /tasks/{taskId} {
      allow read: if isAuthed() && inAgency(resource.data.agencyId);
      allow create: if isAuthed()
          && inAgency(request.resource.data.agencyId)
          && isNonEmptyString(request.resource.data.title);
      allow update: if isAuthed()
          && inAgency(resource.data.agencyId)
          && agencyIdUnchanged();

      allow delete: if isAuthed() && isAgencyAdmin(resource.data.agencyId);
    }


    // ══════════════════════════════════════════════════════════════════════════
    // ALERTS
    // Alert lifecycle (create/delete) is managed by Cloud Functions.
    // Clients may read their own alerts and mark them as read.
    // ══════════════════════════════════════════════════════════════════
    match /alerts/{alertId} {
      allow read: if isAuthed() && inAgency(resource.data.agencyId);

      // Allow client to ONLY flip isRead to true — no other field may change
      allow update: if isAuthed()
          && inAgency(resource.data.agencyId)
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead'])
          && request.resource.data.isRead == true;

      allow create, delete: if false; // Managed strictly by Cloud Functions
    }

    // ══════════════════════════════════════════════════════════════════════════
    // SHARED CATALOGS
    // Public read if not expired. Atomic increment for viewCount.
    // ══════════════════════════════════════════════════════════════════════════
    match /shared_catalogs/{catalogId} {
      // 1. Allow public read if not expired (for clients viewing the catalog link)
      // 2. Allow agents in the same agency to read/query all catalogs for their agency (needed for LeadProfilePanel)
      allow read: if (resource.data.expiresAt > request.time) || (isAuthed() && inAgency(resource.data.agencyId));
      
      // Allow anonymous increments of viewCount (existing)
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']) 
                    && request.resource.data.viewCount == resource.data.viewCount + 1;
      
      // Allow anonymous update of likedPropertyIds — any visitor can like/unlike properties
      // Only the likedPropertyIds field may change, and it must be a list.
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likedPropertyIds'])
                    && request.resource.data.likedPropertyIds is list;
                    
      allow create, delete: if false; // Managed by Cloud Functions
    }


    // ══════════════════════════════════════════════════════════════════════════
    // PENDING LEADS (Inbound WhatsApp messages from unknown numbers)
    // ══════════════════════════════════════════════════════════════════════════
    match /pending_leads/{leadId} {
      allow read, delete: if isAuthed() && inAgency(resource.data.agencyId);
      
      // Clients shouldn't typically create these directly (Cloud Functions/Webhooks do),
      // but if we need a manual "Add Unknown" later:
      allow create: if isAuthed() && inAgency(request.resource.data.agencyId);
    }

    // ══════════════════════════════════════════════════════════════════════════
    // PRIVATE CREDENTIALS (Secure Subcollection)
    // ══════════════════════════════════════════════════════════════════════════
    match /agencies/{agencyId}/private_credentials/{document=**} {
      allow read, write: if false; // Only accessible via Cloud Functions (Admin SDK)
    }

    // ══════════════════════════════════════════════════════════════════════════
    // AVAILABLE INSTANCES (WhatsApp Pool)
    // ══════════════════════════════════════════════════════════════════════════
    match /available_instances/{document=**} {
      allow read, write: if false; // Only accessible via Cloud Functions (Admin SDK)
    }

    // ══════════════════════════════════════════════════════════════════════════
    // SUPER ADMINS (System-wide Administrators)
    // ══════════════════════════════════════════════════════════════════════════
    match /superAdmins/{userId} {
      allow read: if isAuthed() && request.auth.uid == userId;
      allow write: if false; // Only modified directly via Firebase Console
    }
  }
}
