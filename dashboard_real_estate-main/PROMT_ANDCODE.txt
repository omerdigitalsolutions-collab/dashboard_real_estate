# TASK: Refactor WhatsApp Integration to a Managed SaaS Architecture (No Client Credentials)

Act as a Senior React & Firebase Developer. We are upgrading our real estate SaaS CRM (hOMER) WhatsApp integration. 
PREVIOUSLY: The user had to manually input a WAHA/Green API `instanceId` and `apiToken` in the frontend settings.
NEW ARCHITECTURE: We are moving to a fully managed model. The user will NOT see or input any API keys. They will simply click a "Connect WhatsApp" button, see a QR code, and scan it. 

Please build the Frontend React Component (`WhatsAppSettings.tsx` or similar) and the custom hook with the following logic:

## 1. Clean UI (The "Magic" Button)
- Remove the input fields for Instance ID and API Token.
- Show a sleek section with a button: "Connect WhatsApp" (חבר וואטסאפ).
- When clicked, it opens a Modal and calls a Firebase Cloud Function named `generateWhatsAppQR`.
- Display a loading spinner while waiting for the QR code.

## 2. The QR Modal & Polling
- Once the Cloud Function returns the QR code (base64 image or string), display it in the Modal with instructions: "Open WhatsApp -> Linked Devices -> Scan".
- Implement a polling mechanism (e.g., every 5 seconds) that calls another Cloud Function `checkWhatsAppStatus`.
- If the status returns 'CONNECTED' or 'AUTHORIZED', close the Modal automatically, show a success confetti/toast, and update the UI to show "Status: Connected ✅". Provide a "Disconnect" button.

## 3. Webhook Client Refactor
- Ensure that the frontend `webhookClient.ts` (used for sending messages to leads) no longer uses Make.com or local credentials. It must solely call a Firebase Cloud Function `sendWhatsAppMessage` passing only the `phone` and `message`.

Please provide the complete React code for the Settings UI, the QR Modal, and the updated `webhookClient.ts`.


****


קוד השרת (Firebase Cloud Functions)
בזמן שאנטיגרביטי בונה את הממשק היפה ב-React, זה הקוד שאתה צריך לשים בתיקיית back/functions/src/whatsappAuth.ts.

הקוד הזה מבצע את "העבודה השחורה": הוא מייצר למשרד מזהה ייחודי, פותח לו Session בשרת הוואטסאפ המרכזי שלך, שומר את הנתונים ב-Firestore, ומושך את ה-QR.

(הערה: הקוד מותאם לוגית לעבודה מול שרת WAHA/API מרכזי. תצטרך להכניס את כתובת השרת האמיתית שלך למשתני הסביבה).

TypeScript
import * as functions from "firebase-functions";
import * as admin from "firebase-admin";
import axios from "axios";

const db = admin.firestore();

// הכתובת של שרת ה-WAHA המרכזי שלך או ה-Partner API של Green API
const WAHA_BASE_URL = process.env.WAHA_BASE_URL || "http://your-waha-server.com/api";
// מפתח מאסטר שלך מול ספק הוואטסאפ (לא של הלקוח!)
const WAHA_MASTER_KEY = process.env.WAHA_MASTER_KEY; 

/**
 * פונקציה 1: ייצור מופע (Instance) ושליפת QR
 * מופעלת כשהלקוח לוחץ על "חבר וואטסאפ"
 */
export const generateWhatsAppQR = functions.https.onCall(async (data, context) => {
    // 1. אימות שהמשתמש מחובר
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', 'User must be logged in.');
    }

    const uid = context.auth.uid;

    try {
        // 2. שליפת ה-Agency ID של המשתמש
        const userDoc = await db.collection('users').doc(uid).get();
        const agencyId = userDoc.data()?.agencyId;

        if (!agencyId) {
            throw new functions.https.HttpsError('failed-precondition', 'User does not belong to an agency.');
        }

        const sessionName = `agency_${agencyId}`;

        // 3. קריאה לשרת הוואטסאפ ליצירת סשן (מופע) חדש והוצאת QR
        // ב-WAHA, יצירת סשן תחזיר את ה-QR במידה וזה דורש סריקה
        const response = await axios.post(`${WAHA_BASE_URL}/sessions/start`, {
            name: sessionName,
            config: {
                // הגדרות אבטחה וכו'
            }
        }, {
            headers: { 'Authorization': `Bearer ${WAHA_MASTER_KEY}` }
        });

        const qrCodeData = response.data?.qrcode; // מבנה התשובה תלוי בספק הספציפי

        // 4. שמירה שקטה של שם הסשן (Instance) במסמך של המשרד - הלקוח לא רואה את זה!
        await db.collection('agencies').doc(agencyId).update({
            'whatsapp.sessionName': sessionName,
            'whatsapp.status': 'PENDING_SCAN',
            'whatsapp.updatedAt': admin.firestore.FieldValue.serverTimestamp()
        });

        // 5. החזרת ה-QR למסך של הלקוח (למודאל שיצר אנטיגרביטי)
        return { success: true, qrCode: qrCodeData };

    } catch (error) {
        console.error("Error generating QR:", error);
        throw new functions.https.HttpsError('internal', 'Failed to generate QR code.');
    }
});

/**
 * פונקציה 2: שליחת הודעה בצורה מאובטחת
 * מופעלת כשהסוכן לוחץ "שלח" מכרטיסיית הליד
 */
export const sendWhatsAppMessage = functions.https.onCall(async (data, context) => {
    if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'Not logged in');

    const { phone, message } = data;
    const uid = context.auth.uid;

    try {
        // שליפת הסשן הסודי של המשרד מה-Firestore
        const userDoc = await db.collection('users').doc(uid).get();
        const agencyId = userDoc.data()?.agencyId;
        
        const agencyDoc = await db.collection('agencies').doc(agencyId).get();
        const sessionName = agencyDoc.data()?.whatsapp?.sessionName;

        if (!sessionName) {
            throw new functions.https.HttpsError('failed-precondition', 'WhatsApp not connected for this agency.');
        }

        // שיגור ההודעה דרך השרת המרכזי
        await axios.post(`${WAHA_BASE_URL}/sendText`, {
            session: sessionName,
            chatId: `${phone}@c.us`,
            text: message
        }, {
            headers: { 'Authorization': `Bearer ${WAHA_MASTER_KEY}` }
        });

        return { success: true };
    } catch (error) {
        console.error("Error sending message:", error);
        throw new functions.https.HttpsError('internal', 'Failed to send message.');
    }
});
(אל תשכח לייצא את הפונקציות האלו בקובץ ה-index.ts הראשי של תיקיית ה-functions שלך!)