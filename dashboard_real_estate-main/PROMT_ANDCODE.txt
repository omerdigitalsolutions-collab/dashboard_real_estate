#  TASK: Implement WhatsApp Integration (Green API) MVP for Multi-Tenant CRM

Act as a Senior Full-Stack Engineer. We are integrating WhatsApp into our Firebase-based Real Estate CRM using Green API. 
We need to build the MVP integration: a settings UI for the agency admin to connect their WhatsApp via QR code, and a central Cloud Function webhook to receive incoming messages and route them to the correct Lead.

Please install required dependencies first: `npm install qrcode.react axios` (in frontend) and `npm install axios` (in functions).

## 1. Backend (Firebase Cloud Functions)
Create a new file `functions/src/whatsapp.ts` (and make sure to export it in `index.ts`). We need two functions:

A. `getWhatsAppQrCode` (onCall Callable Function):
- Input: `idInstance` (string), `apiTokenInstance` (string), `agencyId` (string).
- Logic: Validate `context.auth`. Make an HTTP GET request to `https://api.greenapi.com/waInstance{idInstance}/qr/{apiTokenInstance}`.
- If successful (response type is "qrCode"), save these credentials to Firestore at `agencies/{agencyId}` under the `whatsappIntegration` object with `status: 'pending'` and a server timestamp.
- Return the QR code base64 string (`response.data.message`) to the client.

B. `whatsappWebhook` (onRequest HTTP Function):
- This is the single global endpoint for all tenants.
- Logic:
  1. Parse the incoming JSON payload from Green API. Always return `res.status(200).send("OK")` immediately to acknowledge receipt.
  2. Extract `idInstance` and `typeWebhook` from the body. Proceed only if `typeWebhook === "incomingMessageReceived"`.
  3. Query the `agencies` collection to find the agency document where `whatsappIntegration.idInstance == idInstance`. If not found, log and return.
  4. Extract the sender's phone number (`body.senderData.sender`). It usually comes as `972501234567@c.us`. Clean it up: remove `@c.us` and change the `972` prefix to `0` (e.g., `0501234567`).
  5. Query the `leads` collection where `agencyId == foundAgencyId` and `phone == cleanPhone`.
  6. If a matching lead is found, extract the text message (`body.messageData.textMessageData.textMessage`).
  7. Add a new document to the subcollection: `leads/{leadId}/messages/`. Data: `{ text: messageText, direction: 'inbound', timestamp: admin.firestore.FieldValue.serverTimestamp(), senderPhone: cleanPhone, isRead: false }`.

## 2. Frontend (React Component)
Create a new component `src/components/settings/WhatsAppSettings.tsx`.

- UI Layout: RTL, Tailwind CSS, clean design. Use Lucide icons (Smartphone, CheckCircle, AlertCircle, Loader2).
- State: Listen to `agencies/{user.agencyId}` in real-time (`onSnapshot`). If `whatsappIntegration.status === 'connected'`, show a green success banner and hide the inputs.
- Inputs: Two text inputs for `idInstance` and `apiTokenInstance`.
- Action: "הפק קוד QR לסריקה" (Generate QR Code) button.
- Logic: On click, call the `getWhatsAppQrCode` Firebase Cloud Function. Manage loading state and error handling.
- Display: Use the `qrcode.react` library (`QRCodeCanvas`) to display the returned base64 string as a visible QR code on the screen.

Generate the complete, robust code for both the Cloud Functions and the React component.


******



הפתרון הזה מחולק לשניים: השרת (Firebase Cloud Functions) שמדבר עם Green API מאחורי הקלעים, והלקוח (React) שמציג לסוכן את ה-QR Code לסריקה.

לפני שמתחילים, ודא שהתקנת את ספריות החובה בתיקיית ה-Frontend שלך:

Bash
npm install qrcode.react axios
1. קוד צד שרת: Cloud Functions
צור או ערוך את הקובץ functions/src/whatsapp.ts (ואל תשכח לייצא אותו ב-index.ts).

TypeScript
import * as functions from "firebase-functions";
import * as admin from "firebase-admin";
import axios from "axios";

// במידה ו-admin.initializeApp() כבר הופעל ב-index.ts
const db = admin.firestore();

/**
 * פונקציה 1: משיכת ה-QR Code מ-Green API
 * מופעלת מהקליינט (הדפדפן) על ידי הסוכן
 */
export const getWhatsAppQrCode = functions.region('europe-west1').https.onCall(async (data, context) => {
  // אימות שהמשתמש מחובר
  if (!context.auth) {
    throw new functions.https.HttpsError("unauthenticated", "רק משתמשים מחוברים יכולים לבצע פעולה זו.");
  }

  const { idInstance, apiTokenInstance, agencyId } = data;
  
  if (!idInstance || !apiTokenInstance || !agencyId) {
    throw new functions.https.HttpsError("invalid-argument", "חסרים פרטי זיהוי של Green API.");
  }

  try {
    // פנייה ל-Green API למשיכת ה-QR כ-Base64
    const url = `https://api.greenapi.com/waInstance${idInstance}/qr/${apiTokenInstance}`;
    const response = await axios.get(url);

    if (response.data && response.data.type === "qrCode") {
      // שמירת המפתחות ב-Firestore של המשרד בסטטוס "ממתין לסריקה"
      await db.collection("agencies").doc(agencyId).set({
        whatsappIntegration: {
          idInstance,
          apiTokenInstance,
          status: 'pending',
          updatedAt: admin.firestore.FieldValue.serverTimestamp()
        }
      }, { merge: true });

      // החזרת המחרוזת לקליינט
      return { qrCode: response.data.message };
    } else {
      throw new functions.https.HttpsError("internal", "Green API לא החזיר קוד QR תקין.");
    }
  } catch (error) {
    console.error("Error fetching QR from Green API:", error);
    throw new functions.https.HttpsError("internal", "שגיאה בתקשורת מול שרתי ווטסאפ.");
  }
});

/**
 * פונקציה 2: ה-Webhook המרכזי לכל המשרדים
 * ה-URL של הפונקציה הזו הוא מה שאתה מזין בהגדרות של Green API
 */
export const whatsappWebhook = functions.region('europe-west1').https.onRequest(async (req, res) => {
  try {
    const body = req.body;
    
    // חובה להחזיר 200 ל-Green API מיד כדי שלא ישלחו שוב ושוב
    res.status(200).send("OK");

    const idInstance = body?.idInstance;
    const typeWebhook = body?.typeWebhook;

    // אנחנו מעוניינים רק בהודעות נכנסות כרגע
    if (!idInstance || typeWebhook !== "incomingMessageReceived") return;

    // חילוץ המספר של השולח וניקוי שלו (Green API שולח בפורמט 972501234567@c.us)
    const rawSender = body?.senderData?.sender;
    const textMessage = body?.messageData?.textMessageData?.textMessage;

    if (!rawSender || !textMessage) return;

    // המרה לפורמט טלפון ישראלי ששמור אצלנו במערכת (0501234567)
    let cleanPhone = rawSender.replace("@c.us", "");
    if (cleanPhone.startsWith("972")) {
      cleanPhone = "0" + cleanPhone.substring(3);
    }

    // 1. מציאת המשרד (Agency) שלו שייך ה-Instance הזה
    const agenciesSnapshot = await db.collection("agencies")
      .where("whatsappIntegration.idInstance", "==", idInstance)
      .limit(1)
      .get();

    if (agenciesSnapshot.empty) {
      console.log(`Webhook Error: Unrecognized idInstance ${idInstance}`);
      return;
    }
    const agencyId = agenciesSnapshot.docs[0].id;

    // 2. מציאת הליד בתוך המשרד הזה לפי מספר טלפון
    const leadsSnapshot = await db.collection("leads")
      .where("agencyId", "==", agencyId)
      .where("phone", "==", cleanPhone)
      .limit(1)
      .get();

    if (leadsSnapshot.empty) {
      // אם אין ליד כזה, אנחנו פשוט מתעלמים מההודעה (אפשר גם לפתוח ליד חדש אוטומטית אם תרצה בעתיד)
      console.log(`Ignored message from ${cleanPhone} - No matching lead found.`);
      return;
    }

    const leadId = leadsSnapshot.docs[0].id;

    // 3. שמירת ההודעה בתת-הקולקציה של הליד
    await db.collection(`leads/${leadId}/messages`).add({
      text: textMessage,
      direction: 'inbound', // הודעה נכנסת
      senderPhone: cleanPhone,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      isRead: false
    });

    console.log(`Successfully routed message to lead ${leadId}`);

  } catch (error) {
    console.error("Fatal Webhook Error:", error);
    // כבר החזרנו 200 קודם, אז רק נרשום בלוגים
  }
});
2. קוד צד לקוח: מסך הגדרות ווטסאפ (React)
צור את הקובץ src/components/settings/WhatsAppSettings.tsx. הקומפוננטה הזו מאזינה ל-Firestore בזמן אמת, מציגה את הטופס, ומציירת את ה-QR ברגע שמתקבל מהשרת.

TypeScript
import React, { useState, useEffect } from 'react';
import { QRCodeCanvas } from 'qrcode.react';
import { getFunctions, httpsCallable } from 'firebase/functions';
import { doc, onSnapshot } from 'firebase/firestore';
import { db } from '../../firebaseConfig'; // ודא נתיב מדויק
import { useAuth } from '../../hooks/useAuth'; // נניח שיש לך הוק כזה
import { Smartphone, CheckCircle, AlertCircle, Loader2 } from 'lucide-react';

export const WhatsAppSettings = () => {
  const { user } = useAuth();
  const [idInstance, setIdInstance] = useState('');
  const [apiToken, setApiToken] = useState('');
  
  const [qrCodeData, setQrCodeData] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  
  const [status, setStatus] = useState<'disconnected' | 'pending' | 'connected'>('disconnected');

  // האזנה בזמן אמת למסמך הסוכנות כדי לדעת אם הווטסאפ התחבר
  useEffect(() => {
    if (!user?.agencyId) return;

    const unsub = onSnapshot(doc(db, 'agencies', user.agencyId), (docSnap) => {
      if (docSnap.exists()) {
        const waData = docSnap.data().whatsappIntegration;
        if (waData) {
          setStatus(waData.status || 'disconnected');
          if (waData.idInstance) setIdInstance(waData.idInstance);
          if (waData.apiTokenInstance) setApiToken(waData.apiTokenInstance);
        }
      }
    });

    return () => unsub();
  }, [user?.agencyId]);

  const handleGenerateQR = async () => {
    if (!idInstance || !apiToken) {
      setError('יש להזין idInstance ו- apiTokenInstance מלוח הבקרה של Green API');
      return;
    }
    
    if (!user?.agencyId) return;

    setLoading(true);
    setError('');
    setQrCodeData(null);

    try {
      const functions = getFunctions();
      const getWhatsAppQrCode = httpsCallable(functions, 'getWhatsAppQrCode');
      
      const result = await getWhatsAppQrCode({
        idInstance: idInstance.trim(),
        apiTokenInstance: apiToken.trim(),
        agencyId: user.agencyId
      });

      const data = result.data as { qrCode: string };
      if (data.qrCode) {
        setQrCodeData(data.qrCode);
      }
    } catch (err: any) {
      console.error(err);
      setError(err.message || 'שגיאה ביצירת קוד QR. בדוק שהמפתחות שהזנת נכונים.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100" dir="rtl">
      <div className="flex items-center gap-3 mb-6">
        <div className="bg-green-100 p-3 rounded-full text-green-600">
          <Smartphone size={24} />
        </div>
        <div>
          <h2 className="text-xl font-bold text-gray-800">חיבור לווטסאפ (Green API)</h2>
          <p className="text-sm text-gray-500">חבר את מספר הווטסאפ של המשרד לקבלת הודעות ישירות לכרטיסי הלידים.</p>
        </div>
      </div>

      {status === 'connected' ? (
        <div className="bg-green-50 border border-green-200 p-5 rounded-lg flex items-start gap-4 text-green-800">
          <CheckCircle size={24} className="mt-0.5 shrink-0" />
          <div>
            <strong className="block text-lg mb-1">הווטסאפ מחובר ופעיל!</strong>
            <p className="text-sm text-green-700">
              המערכת מקבלת הודעות מהלקוחות ומנתבת אותן ללידים הרלוונטיים באופן אוטומטי. 
              המזהה שלך: <span className="font-mono bg-white px-2 py-0.5 rounded text-xs ml-1">{idInstance}</span>
            </p>
          </div>
        </div>
      ) : (
        <div className="space-y-4 max-w-md">
          {error && (
            <div className="bg-red-50 border border-red-100 text-red-600 p-3 rounded-lg flex items-center gap-2 text-sm">
              <AlertCircle size={18} className="shrink-0" />
              <span>{error}</span>
            </div>
          )}

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">מזהה Instance (idInstance)</label>
            <input 
              type="text" 
              value={idInstance}
              onChange={(e) => setIdInstance(e.target.value)}
              className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none transition"
              placeholder="לדוגמה: 1101812345"
              dir="ltr"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">טוקן API (apiTokenInstance)</label>
            <input 
              type="text" 
              value={apiToken}
              onChange={(e) => setApiToken(e.target.value)}
              className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 outline-none transition"
              placeholder="הזן את הטוקן..."
              dir="ltr"
            />
          </div>

          <button 
            onClick={handleGenerateQR}
            disabled={loading || !idInstance || !apiToken}
            className="w-full bg-green-600 text-white font-medium py-2.5 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 flex justify-center items-center gap-2 mt-4"
          >
            {loading ? <Loader2 size={18} className="animate-spin" /> : 'הפק קוד QR לסריקה'}
          </button>

          {qrCodeData && (
            <div className="mt-8 flex flex-col items-center justify-center p-8 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50 relative overflow-hidden">
              <div className="absolute top-0 left-0 w-full h-1 bg-green-500 animate-pulse"></div>
              <p className="text-center font-medium mb-5 text-gray-800">סרוק את הברקוד עם מכשיר הווטסאפ שלך:</p>
              <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <QRCodeCanvas value={qrCodeData} size={220} level="H" />
              </div>
              <p className="text-sm text-gray-500 mt-5 text-center max-w-xs">
                פתח את ווטסאפ במכשיר ➡️ מכשירים מקושרים ➡️ קישור מכשיר, וסרוק את הקוד.
              </p>
            </div>
          )}
        </div>
      )}
    </div>
  );
};