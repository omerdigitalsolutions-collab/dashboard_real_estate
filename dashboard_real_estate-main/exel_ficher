promt: 
# TASK: Implement Excel / Sheet Bulk Import Feature(Multi - Entity)

Act as a Senior Full - Stack Engineer.We are building a bulk data import
system that parses Excel / CSV files and writes to Firestore.Security,
    validation, and UX are top priorities.

## Architecture Overview
    - Leads & Properties: Client - side parse → direct Firestore write(via existing Rules)
        - Agents: Client - side parse → Cloud Function`inviteAgent`(server - side only)

---

## 1. Dependencies
Add to package.json:
* `xlsx`(SheetJS) — for parsing Excel / CSV files client - side.

---

## 2. Import Service(`src/services/importService.ts`)

### `parseFile(file: File)`
    * Use SheetJS to read the uploaded file(supports.xlsx, .xls, .csv).
* Return: `{ headers: string[], rows: Record<string, any>[] }`

### `validateAndTransform(rows, mapping, entityType)`
    * Input:
- `rows`: raw parsed rows
    - `mapping`: user - defined column mapping`{ excelColumn: firestoreField }`
        - `entityType`: 'lead' | 'property' | 'agent'
            * Logic:
1. Apply the mapping to transform each row.
  2. Validate each row against required fields:
- Lead: name(string), phone(string)
    - Property: address(string), city(string), type(string), price(number > 0)
        - Agent: name(string), email(string)
3. Return: `{ valid: TransformedRow[], invalid: { row, reason }[] }`

### `importLeads(agencyId, rows)`
    * Write valid rows to Firestore in batches of 400(safe under 500 limit).
* Inject: `agencyId`, `status: 'new'`, `source: 'import'`, `serverTimestamp()`.
* Duplicate check: before writing, query by phone.If exists → skip and log.

### `importProperties(agencyId, rows)`
    * Same batch logic as importLeads.
* Inject: `agencyId`, `status: 'active'`, `serverTimestamp()`.
* Duplicate check: query by address + city.If exists → skip and log.

### `importAgents(rows)`
    * Do NOT write directly to Firestore.
* For each valid row, call the existing `inviteAgent` Cloud Function.
* Handle errors per - row(e.g., agent already exists) without stopping the batch.

---

## 3. UI Component: `<ImportModal />`
    (`src/components/modals/ImportModal.tsx`)

### Step 1 — Upload
    * Drag - and - drop zone + file picker.
* Accepted formats: .xlsx, .xls, .csv
    * On file select: call `parseFile()` and show preview of first 5 rows.
* Entity type selector: "מה מכיל הקובץ?" → Leads / Properties / Agents(tabs).

### Step 2 — Column Mapping
    * Display a table: one row per Excel column header.
* For each column, show a dropdown of available Firestore fields for 
  the selected entity type.
* Mark required fields visually(red asterisk).
* "Auto-detect" button: attempt to match column names to field names
automatically(e.g., "טלפון" → phone, "מחיר" → price).

### Step 3 — Validation Preview
    * Run`validateAndTransform()` and show results:
- Green section: "X שורות תקינות ומוכנות לייבוא"
    - Red section: "Y שורות עם שגיאות" — show each row + reason.
  - Option: "הורד קובץ שגיאות"(export invalid rows back to Excel).

### Step 4 — Import Progress
    * Show a progress bar(currentBatch / totalBatches).
* On complete: show summary toast: "יובאו בהצלחה: X לידים, Y נכסים. נדחו: Z שורות."

---

## 4. Duplicate Strategy(user must choose before import )
Present a radio selection:
* "דלג על כפילויות"(Skip) — default
* "עדכן רשומות קיימות"(Update / Merge)
    * "צור רשומה חדשה בכל מקרה"(Always create)

---

## 5. Error Handling
    * If a Firestore batch fails mid - way: show which rows succeeded 
  and which failed.Do NOT silently lose data.
* If an agent invite fails(e.g., already exists): mark that row 
  as skipped, continue with the rest.
* "Permission Denied" errors should show:
"אין לך הרשאה לייבא נתונים. פנה למנהל המשרד."

---

## Design Language
    * RTL layout.Clean Luxury Tailwind theme.
* Step indicator(1 → 2 → 3 → 4) at the top of the modal.
* Use Lucide icons: Upload, Table, CheckCircle, AlertCircle.
* Accessible: keyboard navigable, screen reader friendly labels.

Generate the complete, type - safe code for the service and UI component.
******************

    זה הקוד הבסיסי.תשפר אותו


import React, { useState } from 'react';
import { Upload, Table as TableIcon, CheckCircle, AlertCircle, ChevronLeft, ChevronRight, Download } from 'lucide-react';
import { useAuth } from '../../hooks/useAuth';
import {
    parseFile, validateAndTransform, importLeads, importProperties,
    importAgents, exportErrorsToExcel, EntityType, DuplicateStrategy, ValidationResult
} from '../../services/importService';

interface ImportModalProps {
    isOpen: boolean;
    onClose: () => void;
}

const FIELD_OPTIONS = {
    lead: [
        { key: 'name', label: 'שם מלא (חובה)' },
        { key: 'phone', label: 'טלפון (חובה)' },
        { key: 'email', label: 'אימייל' },
        { key: 'budget', label: 'תקציב מקסימלי' }
    ],
    property: [
        { key: 'city', label: 'עיר (חובה)' },
        { key: 'address', label: 'כתובת רחוב (חובה)' },
        { key: 'type', label: 'סוג נכס (חובה)' },
        { key: 'price', label: 'מחיר (חובה)' },
        { key: 'rooms', label: 'מספר חדרים' }
    ],
    agent: [
        { key: 'name', label: 'שם מלא (חובה)' },
        { key: 'email', label: 'אימייל (חובה)' },
        { key: 'role', label: 'תפקיד (agent/admin)' }
    ]
};

const COMMON_HEBREW_MAPPINGS: Record<string, string> = {
    'שם': 'name', 'שם מלא': 'name', 'שם הלקוח': 'name',
    'טלפון': 'phone', 'נייד': 'phone', 'מספר': 'phone',
    'אימייל': 'email', 'דואל': 'email', 'מייל': 'email',
    'עיר': 'city', 'יישוב': 'city',
    'כתובת': 'address', 'רחוב': 'address',
    'מחיר': 'price', 'סכום': 'price',
    'סוג': 'type', 'סוג נכס': 'type',
    'תפקיד': 'role', 'הרשאה': 'role'
};

export const ImportModal: React.FC<ImportModalProps> = ({ isOpen, onClose }) => {
    const { user } = useAuth();
    const [step, setStep] = useState<1 | 2 | 3 | 4>(1);
    const [entityType, setEntityType] = useState<EntityType>('lead');
    const [rawHeaders, setRawHeaders] = useState<string[]>([]);
    const [rawRows, setRawRows] = useState<any[]>([]);

    const [mapping, setMapping] = useState<Record<string, string>>({});
    const [validation, setValidation] = useState<ValidationResult>({ valid: [], invalid: [] });
    const [strategy, setStrategy] = useState<DuplicateStrategy>('skip');

    const [isProcessing, setIsProcessing] = useState(false);
    const [progress, setProgress] = useState({ current: 0, total: 0 });
    const [errorMsg, setErrorMsg] = useState('');
    const [summary, setSummary] = useState({ success: 0, failed: 0 });

    if (!isOpen) return null;

    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setErrorMsg('');
        try {
            const { headers, rows } = await parseFile(file);
            setRawHeaders(headers);
            setRawRows(rows);
            setStep(2);
        } catch (err: any) {
            setErrorMsg(err.message);
        }
    };

    const handleAutoMap = () => {
        const newMapping: Record<string, string> = {};
        rawHeaders.forEach(header => {
            const matchedField = COMMON_HEBREW_MAPPINGS[header.trim()];
            if (matchedField && FIELD_OPTIONS[entityType].some(f => f.key === matchedField)) {
                newMapping[header] = matchedField;
            }
        });
        setMapping(newMapping);
    };

    const handleValidation = () => {
        setErrorMsg('');
        const requiredFields = FIELD_OPTIONS[entityType]
            .filter(f => f.label.includes('חובה'))
            .map(f => f.key);

        const mappedFields = Object.values(mapping);
        const missingRequired = requiredFields.filter(f => !mappedFields.includes(f));

        if (missingRequired.length > 0) {
            const missingLabels = missingRequired.map(key =>
                FIELD_OPTIONS[entityType].find(f => f.key === key)?.label
            );
            setErrorMsg(`חסר מיפוי לשדות חובה: ${missingLabels.join(', ')}`);
            return;
        }

        const res = validateAndTransform(rawRows, mapping, entityType);
        setValidation(res);
        setStep(3);
    };

    const executeImport = async () => {
        if (!user?.agencyId) return setErrorMsg('שגיאת מערכת: מזהה משרד חסר.');
        setIsProcessing(true);
        setErrorMsg('');

        const onProgress = (current: number, total: number) => {
            setProgress({ current, total });
        };

        try {
            let imported = 0;
            if (entityType === 'lead') {
                imported = await importLeads(user.agencyId, user.uid, validation.valid, strategy, onProgress);
            } else if (entityType === 'property') {
                imported = await importProperties(user.agencyId, user.uid, validation.valid, strategy, onProgress);
            } else if (entityType === 'agent') {
                const res = await importAgents(user.agencyId, validation.valid, onProgress);
                imported = res.importedCount;
                setSummary({ success: res.importedCount, failed: res.failedCount + validation.invalid.length });
                setStep(4);
                setIsProcessing(false);
                return;
            }

            setSummary({ success: imported, failed: validation.invalid.length });
            setStep(4);
        } catch (err: any) {
            setErrorMsg(err.message || 'אירעה שגיאה בלתי צפויה במהלך הייבוא.');
        } finally {
            setIsProcessing(false);
        }
    };

    return (
        <div className= "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" dir = "rtl" >
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]" >

                {/* Header & Stepper */ }
                < div className = "p-6 border-b bg-gray-50 flex justify-between items-center" >
                    <h2 className="text-xl font-bold text-gray-800" > ייבוא נתונים מקובץ </h2>
                        < div className = "flex items-center gap-2 text-sm font-medium text-gray-500" >
                            <span className={ step >= 1 ? 'text-blue-600' : '' }> 1. העלאה </span> •
                                < span className = { step >= 2 ? 'text-blue-600' : ''
}> 2. מיפוי </span> •
    < span className = { step >= 3 ? 'text-blue-600' : ''}> 3. אימות </span> •
        < span className = { step === 4 ? 'text-blue-600' : ''}> 4. סיום </span>
            </div>
            </div>

{/* Content Area */ }
<div className="p-6 overflow-y-auto flex-1" >
    { errorMsg && (
        <div className="mb-4 p-4 bg-red-50 text-red-700 rounded-lg flex items-center gap-2" >
            <AlertCircle size={ 20 } className = "shrink-0" />
                <span>{ errorMsg } </span>
                </div>
          )}

{/* STEP 1: Upload */ }
{
    step === 1 && (
        <div className="space-y-6" >
            <div>
            <label className="block text-sm font-semibold mb-2" > מה מכיל הקובץ ? </label>
                < div className = "flex gap-4" >
                    {(['lead', 'property', 'agent'] as EntityType[]).map(type => (
                        <label key= { type } className = "flex items-center gap-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50 flex-1" >
                        <input 
                        type="radio" 
                        name = "entityType" 
                        checked = { entityType === type}
onChange = {() => setEntityType(type)}
className = "text-blue-600"
    />
    <span>{ type === 'lead' ? 'לידים (לקוחות)' : type === 'property' ? 'נכסים' : 'סוכנים (צוות)'}</span>
        </label>
                  ))}
</div>
    </div>

    < label className = "border-2 border-dashed border-gray-300 rounded-xl p-10 flex flex-col items-center justify-center gap-4 cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition-colors" >
        <div className="bg-blue-100 text-blue-600 p-4 rounded-full" >
            <Upload size={ 32 } />
                </div>
                < div className = "text-center" >
                    <span className="font-semibold text-blue-600 text-lg" > לחץ לבחירת קובץ </span>
                        < p className = "text-gray-500 text-sm mt-1" > תומך בפורמטים: .xlsx, .xls, .csv </p>
                            </div>
                            < input type = "file" className = "hidden" accept = ".xlsx, .xls, .csv" onChange = { handleFileUpload } />
                                </label>
                                </div>
          )}

{/* STEP 2: Mapping */ }
{
    step === 2 && (
        <div className="space-y-4" >
            <div className="flex justify-between items-end" >
                <p className="text-gray-600" > שייך את עמודות האקסל לשדות המתאימים במערכת.</p>
                    < button onClick = { handleAutoMap } className = "text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-lg flex items-center gap-2" >
                        <TableIcon size={ 16 } /> זיהוי אוטומטי
                            </button>
                            </div>

                            < div className = "border rounded-lg overflow-hidden" >
                                <table className="w-full text-right text-sm" >
                                    <thead className="bg-gray-50 border-b" >
                                        <tr>
                                        <th className="p-3" > עמודה בקובץ({ rawRows.length } שורות) </th>
                                            < th className = "p-3" > שדה במערכת </th>
                                                </tr>
                                                </thead>
                                                <tbody>
    {
        rawHeaders.map((header) => (
            <tr key= { header } className = "border-b last:border-0 hover:bg-gray-50" >
            <td className="p-3 font-medium text-gray-700" > { header } </td>
        < td className = "p-3" >
        <select 
                            className="w-full border p-2 rounded-md focus:ring-2 focus:ring-blue-500 bg-white"
                            value = { mapping[header] || '' }
                            onChange = {(e) => {
            setErrorMsg(''); 
                              setMapping({ ...mapping, [header]: e.target.value
        });
    }
}
                          >
    <option value="" > --התעלם מעמודה זו-- </option>
{
    FIELD_OPTIONS[entityType].map(opt => (
        <option key= { opt.key } value = { opt.key } > { opt.label } </option>
    ))
}
</select>
    </td>
    </tr>
                    ))}
</tbody>
    </table>
    </div>
    </div>
          )}

{/* STEP 3: Validation Preview */ }
{
    step === 3 && (
        <div className="space-y-6" >
            <div className="grid grid-cols-2 gap-4" >
                <div className="bg-green-50 border border-green-200 p-4 rounded-xl flex items-center justify-between" >
                    <div>
                    <h3 className="text-green-800 font-bold text-lg" > תקינות לטעינה </h3>
                        < p className = "text-green-600 text-sm" > { validation.valid.length } שורות מוכנות </p>
                            </div>
                            < CheckCircle className = "text-green-500" size = { 32} />
                                </div>
                                < div className = "bg-red-50 border border-red-200 p-4 rounded-xl flex items-center justify-between" >
                                    <div>
                                    <h3 className="text-red-800 font-bold text-lg" > שגיאות שנמצאו </h3>
                                        < p className = "text-red-600 text-sm" > { validation.invalid.length } שורות יתעלמו </p>
                                            </div>
                                            < AlertCircle className = "text-red-500" size = { 32} />
                                                </div>
                                                </div>

    {
        validation.invalid.length > 0 && (
            <div className="border rounded-lg overflow-hidden" >
                <div className="bg-gray-50 p-3 flex justify-between items-center border-b" >
                    <span className="font-semibold text-gray-700" > פירוט שגיאות </span>
                        < button onClick = {() => exportErrorsToExcel(validation.invalid)
    } className = "text-blue-600 text-sm flex items-center gap-1 hover:underline" >
        <Download size={ 16 } /> הורד קובץ שגיאות
            </button>
            </div>
            < ul className = "max-h-40 overflow-y-auto p-3 text-sm text-red-600 space-y-1" >
            {
                validation.invalid.map((inv, idx) => (
                    <li key= { idx } className = "bg-white p-2 border-b last:border-0" > { inv.reason } </li>
                ))
            }
                </ul>
                </div>
              )
}

{
    entityType !== 'agent' && (
        <div className="bg-gray-50 p-4 rounded-lg border" >
            <h4 className="font-semibold mb-2" > טיפול בכפילויות </h4>
                < div className = "space-y-2 text-sm" >
                    <label className="flex items-center gap-2 cursor-pointer" >
                        <input type="radio" name = "strategy" checked = { strategy === 'skip'
} onChange = {() => setStrategy('skip')} />
    < span > דלג על רשומות קיימות(ברירת מחדל) </span>
        </label>
        < label className = "flex items-center gap-2 cursor-pointer" >
            <input type="radio" name = "strategy" checked = { strategy === 'update'} onChange = {() => setStrategy('update')} />
                < span > עדכן רשומות קיימות(לפי מזהה ייחודי) </span>
                    </label>
                    < label className = "flex items-center gap-2 cursor-pointer" >
                        <input type="radio" name = "strategy" checked = { strategy === 'always_create'} onChange = {() => setStrategy('always_create')} />
                            < span > צור רשומה חדשה בכל מקרה </span>
                                </label>
                                </div>
                                </div>
              )}
</div>
          )}

{/* STEP 4: Success Summary */ }
{
    step === 4 && (
        <div className="text-center py-10 space-y-4" >
            <div className="bg-green-100 text-green-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm" >
                <CheckCircle size={ 40 } />
                    </div>
                    < h2 className = "text-2xl font-bold text-gray-800" > הייבוא הושלם בהצלחה! </h2>
                        < p className = "text-gray-600 text-lg" >
                            נוספו למערכת: <strong className="text-green-600" > { summary.success } </strong> רשומות.
                                </p>
    {
        summary.failed > 0 && (
            <p className="text-red-500 text-sm" >
                { summary.failed } שורות נכשלו או דולגו בשל שגיאות / כפילויות.
                </p>
              )
    }
    </div>
          )
}
</div>

{/* Footer Actions & Progress Bar */ }
<div className="p-4 border-t bg-gray-50 flex flex-col gap-3" >
    {/* Progress Bar Display */ }
{
    isProcessing && progress.total > 0 && (
        <div className="w-full bg-gray-200 rounded-full h-2.5 mb-2" >
            <div 
                className="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
    style = {{ width: `${Math.round((progress.current / progress.total) * 100)}%` }
}
              > </div>
    < div className = "text-xs text-center text-gray-500 mt-1" >
        מעבד { progress.current } מתוך { progress.total } רשומות...
</div>
    </div>
          )}

<div className="flex justify-between items-center" >
    { step === 4 ? (
        <button onClick= { onClose } className = "w-full bg-gray-800 text-white py-2 rounded-lg font-medium hover:bg-gray-900 transition" >
            סגור חלון
                </button>
            ) : (
    <>
    <button 
                  onClick= {() => step > 1 ? setStep(step - 1 as any) : onClose()}
className = "px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg flex items-center gap-1 font-medium"
disabled = { isProcessing }
    >
    <ChevronRight size={ 18 } /> {step === 1 ? 'ביטול' : 'חזור'}
        </button>

{
    step === 2 && (
        <button onClick={ handleValidation } className = "px-6 py-2 bg-blue-600 text-white rounded-lg flex items-center gap-2 font-medium shadow hover:bg-blue-700 transition" >
            המשך לאימות < ChevronLeft size = { 18} />
                </button>
                )
}

{
    step === 3 && (
        <button 
                    onClick={ executeImport }
    disabled = { validation.valid.length === 0 || isProcessing }
    className = "px-6 py-2 bg-green-600 disabled:bg-gray-400 text-white rounded-lg flex items-center gap-2 font-medium shadow hover:bg-green-700 transition min-w-[150px] justify-center"
        >
        { isProcessing? 'טוען...': 'התחל ייבוא נתונים' }
        </button>
                )
}
</>
            )}
</div>
    </div>

    </div>
    </div>
  );
};